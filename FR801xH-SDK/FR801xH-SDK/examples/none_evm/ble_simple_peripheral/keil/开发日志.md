# 五羊本田蓝牙开发日志（标准模板 + 示例 Demo）

> 目的：把“做了什么、为什么这么做、怎么验证、结果如何、遗留问题与后续计划”固化成统一格式，方便：
> - 复盘/交接/汇报
> - 定位问题（尤其是 BLE 多连接/扫描这类时序问题）
> - 追溯每次改动对应的验证证据

---

## 0. 工程元信息（首次填写，后续更新）

- 工程名称：ble_simple_peripheral（Keil uVision）
- 芯片/内核：ARM Cortex-M3（工程设备：ARMCM3）
- 工具链：ARMCC 5.06（工程配置：ARM-ADS）
- 构建产物：
	- Objects/ble_simple_peripheral.axf
	- Output/ble_simple_peripheral.txt（fromelf --text 导出）
	- Output/ble_simple_peripheral.bin（fromelf --bin 导出）
- 相关文档（本目录内）：
	- BLE_UUID_Profile_nRFConnect_指南.md
	- BLE_三手机连接_同时扫描_双角色指南.md
- 自研模块（本目录内）：
	- protocol.h（协议帧头/解析对象/校验接口）
	- usart_device.h（UART 抽象层/初始化接口）

---

## 1. 日志条目模板（每次开发复制一份）

### [日期] 2025-__-__  [条目编号] __  [作者] __

#### 1) 目标（What）
- 需求/目的：
- 约束：功耗/实时性/兼容性/资源（Flash/RAM）/协议约束：

#### 2) 背景与原因（Why）
- 为什么要做：
- 当前现状/问题描述：
- 预期收益/风险：

#### 3) 方案（How - Design）
- 方案要点：
- 关键接口/事件：
- 影响范围：

#### 4) 实现（How - Implementation）
- 改动点清单：
- 关键逻辑说明：

#### 5) 验证（Test/Verify）
- 编译：是否通过（YES/NO），编译器/配置：
- 下载/烧录：方式（Keil/JLink/串口等）：
- 功能验证步骤：
- 结果：PASS/FAIL（附现象与数据，如 RSSI、连接数、扫描上报次数）

#### 6) 问题与定位（Bug/Issue）
- 现象：
- 复现步骤：
- 可能原因（按优先级列出）：
- 已尝试/证据（log/抓包/变量值/对比试验）：
- 结论：

#### 7) 产出物（Artifacts）
- 产物：bin/axf/截图/抓包：
- 相关文档更新：

#### 8) 后续计划（Next）
- [ ] 
- [ ] 

---

## 2. 示例 Demo（结合你当前工程内容，给你一个“标准写法”）

### [日期] 2025-12-31  [条目编号] 001  [作者] Fan_zx

#### 1) 目标（What）
- 建立统一的开发日志格式，并把当前工程关键任务（UUID 服务/多手机连接/同时扫描/协议+UART）纳入日志结构。

#### 2) 背景与原因（Why）
- 目前日志只有零散记录（例如“创建uuid服务用于通信”），缺少：验证步骤、结果、问题原因、可追溯变更点。
- BLE 多连接 + 扫描属于强时序场景，后期一旦出现“连不上/掉线/扫不到/notify丢包”，没有结构化日志会很难回溯。

#### 3) 方案（How - Design）
- 固化 8 个部分：目标/原因/方案/实现/验证/问题定位/产出物/后续计划。
- 模块映射：
	- 协议：protocol.h
	- 串口：usart_device.h
	- BLE 多连接与扫描：参考 BLE_三手机连接_同时扫描_双角色指南.md 的 GAP 事件/接口。

#### 4) 实现（How - Implementation）
- 本次仅更新开发日志文档格式，不改代码。

#### 5) 验证（Test/Verify）
- 编译/烧录：不涉及。
- 结果：日志模板可直接复制使用。

#### 6) 问题与定位（Bug/Issue）
- 无。

#### 7) 产出物（Artifacts）
- 文档：开发日志.md（本文件）

#### 8) 后续计划（Next）
- [ ] 把“UUID 服务定义/特征值/权限/notify流程”按条目编号记录到日志
- [ ] 把“3 手机连接 + 继续广播 + 同时扫描”的实现与验证数据写成条目
- [ ] 把 UART 收发与协议帧解析/校验的联调过程写成条目（含抓包/串口log）

---

### [日期] 2025-12-31  [条目编号] 002  [作者] Fan_zx

#### 1) 目标（What）
- 创建自定义 UUID 服务，用于 SOC 与 App 端双向通信（读/写/Notify）。

#### 2) 背景与原因（Why）
- App 侧需要一套稳定的数据通道；使用自定义 GATT Service/Characteristic 便于版本扩展与权限管理。

#### 3) 方案（How - Design）
- 参考 BLE_UUID_Profile_nRFConnect_指南.md：
	- 定义 Service UUID（128-bit）
	- 定义 Characteristic：
		- RX（App->SOC 写入）
		- TX（SOC->App Notify/Indicate）
- 协议建议：TX/RX 负载统一使用 protocol.h 的帧格式，便于加密/序号/命令管理。

#### 4) 实现（How - Implementation）
- 改动点清单（示例写法，后续你按真实文件补齐）：
	- code/simple_gatt_service.c：新增 service/char、写回调、notify 入口
	- code/ble_simple_peripheral.c：连接建立后初始化 CCCD 状态、订阅处理
	- protocol.h：定义 cmd 与 payload 结构（如果需要扩展）

#### 5) 验证（Test/Verify）
- 工具：nRF Connect（Android/iOS）
- 步骤：
	1) 手机扫描到设备并连接
	2) Discover services，确认自定义 Service/Characteristic UUID 正确
	3) 对 TX 打开 Notify
	4) 向 RX 写入测试帧（含 seq_num/cmd/payload）
	5) 观察 SOC 回包/notify 是否符合 protocol.h
- 结果：PASS/FAIL（填写：写入是否成功、notify 是否收到、延时/丢包情况）

#### 6) 问题与定位（Bug/Issue）
- 常见原因提示（如果出现问题，按这个结构写原因，不要只写“失败”）：
	- 现象：notify 打不开/写入无响应
	- 可能原因：CCCD 未正确处理、Handle/权限配置错误、连接参数导致 MTU/分包问题、协议帧 length/BCC 校验失败

#### 7) 产出物（Artifacts）
- 版本：ble_simple_peripheral.bin（记录产物时间戳/MD5可选）
- 抓包/截图：nRF Connect 操作截图、串口log

#### 8) 后续计划（Next）
- [ ] 明确协议 cmd 列表与 ACK 策略（CMD_ACK_ID=0x0000 的使用规则）
- [ ] 加入 seq_num 重传/超时策略（如 App/SOC 双端一致）

---

### [日期] 2025-12-31  [条目编号] 003  [作者] Fan_zx

#### 1) 目标（What）
- 支持 3 个手机同时连接（手机=Central，SOC=Peripheral），并在保持连接时 SOC 同时作为 Central 扫描周围设备（Multi-Role）。

#### 2) 背景与原因（Why）
- 业务需要：多手机并发连接 + 设备侧持续扫描。
- BLE 连接后默认停止广播，如果不“连接后继续广播”，第二/第三台手机无法再连接。

#### 3) 方案（How - Design）
- 参考 BLE_三手机连接_同时扫描_双角色指南.md：
	- 连接事件：GAP_EVT_SLAVE_CONNECT / GAP_EVT_DISCONNECT
	- 查询连接数：gap_get_connect_num()
	- 扫描：gap_start_scan()/gap_stop_scan()，关注 GAP_EVT_ADV_REPORT / GAP_EVT_SCAN_END
- 核心策略：
	- 每次收到连接事件后，如果 gap_get_connect_num() < MAX_PHONE_LINK，则继续 gap_start_advertising(0)
	- 连接保持期间按策略启动扫描（注意扫描窗口/间隔与连接事件冲突风险）

#### 4) 实现（How - Implementation）
- 改动点清单（示例写法，后续你按真实文件补齐）：
	- code/ble_simple_peripheral.c：在 app_gap_evt_cb() 的 GAP_EVT_SLAVE_CONNECT 分支补“继续广播”
	- code/scanner.c：封装扫描启动/停止与事件上报

#### 5) 验证（Test/Verify）
- 步骤：
	1) 依次用 3 台手机连接设备，记录每次连接后是否继续能被扫描到
	2) 在 3 条连接都在的情况下启动扫描，检查是否收到 GAP_EVT_ADV_REPORT（RSSI/地址/数据长度）
	3) 断开其中 1 台手机，验证是否自动补广播、连接数是否恢复
- 数据记录（建议填表）：
	- 连接数曲线：0->1->2->3
	- 扫描上报频率：每分钟 adv report 数
	- 掉线/重连次数：
- 结果：PASS/FAIL

#### 6) 问题与定位（Bug/Issue）
- 若出现“第二台/第三台连不上”的常见原因：
	- 连接建立后未重新开始广播（外设正常行为导致广播停止）
	- 广播参数被修改/停止
- 若出现“连接在但扫不到/扫描不稳定”的常见原因：
	- scan_window/scan_intv 与连接事件冲突，导致调度拥塞
	- 多角色资源不足或 SDK 内部限制（需结合事件与返回码定位）

#### 7) 产出物（Artifacts）
- 串口 log：连接事件(conidx)/扫描事件统计
- 抓包：手机端连接与广播行为（可选）

#### 8) 后续计划（Next）
- [ ] 固化 MAX_PHONE_LINK=3 的宏与连接索引管理（conidx 保存/释放）
- [ ] 加入扫描参数表（scan_intv/window/duration）并做稳定性对比

---

## 3. 备注：当前工作区限制（重要）

- 目前 VS Code 工作区根目录是本 keil 文件夹，所以我“无法直接读取 keil 的上级目录源码（例如 code/ 目录）”。
- 如果你希望我自动把日志里的“改动点清单”精确到真实文件与函数名，请把工作区根目录切到 examples/none_evm/ble_simple_peripheral（包含 code/ 目录），或把上级目录添加到工作区。