# 实现蓝牙连接后设备主动同步数据功能

## 需求分析

用户要求实现每次蓝牙连接上后，设备主动向APP同步一次数据的功能。新的同步数据需要包含大量新字段，如User档设置、助力推车设置、延时大灯设置、充电功率、自动P档设置、和弦喇叭设置、三色氛围灯设置等。

## 实现计划

### 1. 更新设备主动同步数据命令

* 修改 `protocol/simulator.py` 中的 `_handle_device_sync_data` 方法

* 按照新的蓝牙协议格式构建响应数据

* 包含所有要求的字段：

  * User档开关、速度、扭矩

  * 助力推车开关、速度

  * 延时大灯开关、延时时间

  * 充电功率

  * 自动P档开关、延时时间

  * 和弦喇叭音源、音量

  * 三色氛围灯效果、渐变模式、RGB值

  * 智能开关集1、2、3、4

  * 倒车开关、速度

  * 防盗器设防状态、灵敏度、工作音量

  * 自动转向回位设置

  * EBS强度设置

  * 低速挡、中速挡、高速挡扭矩

  * ECO档速度设置

  * 起步强度设置

  * 蓝牙感应解锁灵敏度

  * SPORT档速度设置

### 2. 更新命令定义

* 修改 `data/commands.json` 文件

* 更新 `0x209` 设备主动同步数据命令的描述，使其符合新的功能要求

### 3. 测试和验证

* 确保更新后的命令能够正确生成符合新协议格式的数据

* 验证所有字段都按照要求包含在同步数据中

* 确保数据格式和长度符合蓝牙协议的要求

## 技术实现要点

* 按照新的蓝牙协议格式构建响应数据

* 确保所有字段的长度和顺序正确

* 为智能开关集构建正确的字节值，按照用户提供的位定义

* 保持与现有代码的兼容性，确保其他功能不受影响

